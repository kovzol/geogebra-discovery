#!/bin/sh -x
. include/common

if [ "$MATHEMATICA" = "" -a "$1" != "win" -a "$1" != "lin-force" ]; then
 echo "Mathematica is not installed."
 echo "Add 'win' or 'lin-force' to build a Windows package or to build the package without realgeom, respectively."
 exit 1
 fi

test -x fork/geogebra/desktop/build/install/desktop/bin/desktop
rm -fr dist/$PACKAGE_NAME
mkdir -p dist/$PACKAGE_NAME/geogebra
cp -ur fork/geogebra/desktop/build/install/desktop dist/$PACKAGE_NAME/geogebra
# Cross-platform deployment (from Linux to Windows only)
if [ "$1" = win ]; then
 for i in linux mac; do
  rm -f dist/$PACKAGE_NAME/geogebra/desktop/lib/*$i*.jar
  done
 rm -f dist/$PACKAGE_NAME/geogebra/desktop/bin/desktop
 echo "@echo Welcome to $SOFTWARE_NAME
@geogebra\\desktop\\\\bin\\desktop.bat %*" > dist/$PACKAGE_NAME/GeoGebra-Discovery.bat
 ZIPNAME=$PACKAGE_NAME-Windows

else
# Non-cross-platform deployment
cp -ur realgeom dist/$PACKAGE_NAME
mkdir -p dist/$PACKAGE_NAME/helper
cp include/detect dist/$PACKAGE_NAME/helper
rm -f dist/$PACKAGE_NAME/geogebra/desktop/bin/desktop.bat

if [ "$LINUX_VARIANT" = Raspbian ]; then
 for i in windows mac i586 amd64 libpxcc zspace; do
  rm -f dist/$PACKAGE_NAME/geogebra/desktop/lib/*$i*.jar
  done
 ZIPNAME=$PACKAGE_NAME-RaspberryPi
else
 for i in windows mac i586 arm libpxcc zspace; do
  rm -f dist/$PACKAGE_NAME/geogebra/desktop/lib/*$i*.jar
  done
 ZIPNAME=$PACKAGE_NAME-Linux64
 fi
# Linux startup shell
echo "#!/bin/sh
echo \"Welcome to $SOFTWARE_NAME\"
. helper/detect
if [ \"\$MATHEMATICA\" != \"\" ]; then
 echo -n \"Starting local RealGeom server on port 8765...\"
 \$TERMINAL -e \"cd realgeom; ./gradlew run --args=\\\"-s\\\"\" 2>/dev/null &
 REALGEOM_PID=\$!
 while ! nc -z localhost 8765; do sleep 1; echo -n .; done
 echo
 echo -n \"Launching GeoGebra...\"
 geogebra/desktop/bin/desktop --realgeomws=remoteurl:http\\://localhost\\:8765 \"\$@\"
 echo \"GeoGebra session ended.\"
 echo \"Stopping RealGeom session...\"
 kill \$REALGEOM_PID
else
 geogebra/desktop/bin/desktop \"\$@\"
 fi" > dist/$PACKAGE_NAME/GeoGebra-Discovery
chmod 755 dist/$PACKAGE_NAME/GeoGebra-Discovery
fi # End of non-cross-platform deployment

# Common parts in all types of deployments
ZIPNAME=$ZIPNAME.zip
cd dist
rm -f $ZIPNAME
zip -9r $ZIPNAME $PACKAGE_NAME
